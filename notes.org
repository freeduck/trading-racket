# -*- org-use-property-inheritance: t; org-confirm-babel-evaluate: nil;-*-
* Notes
** First dataset
 2018-11-18 22:21:00

 2019-02-18 22:21:00
 [[file:2018-11-18-22:21:00-2019-02-18-22:21:00.db]]
** COMMENT Test
tests are in ./test.rkt also testing plot

#+name: test-data
#+begin_src racket :results output drawer :noweb yes
  (require db)
  (define *db*
    (sqlite3-connect #:database
                     "2018-11-18-22:21:00-2019-02-18-22:21:00.db"))
#+end_src

#+RESULTS: test-data
:results:
:end:

#+name: data-sorce
#+begin_src racket :results output drawer :noweb yes
  (require crypto-trading/data)
  (define test-data-source (select-window *db*))
#+end_src

#+name: plot-first-peak-target
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test-data
           crypto-trading/plot
           crypto-trading/fit)
  (define rows (test-data-source first-trade second-trade-target))
  (define plotables (list (lines rows)
                          (function (make-fitf rows))))
  (plot-on-frame plotables)
#+end_src

#+RESULTS:
:results:
:end:

#+name: plot-first-peak-no-filters
#+begin_src racket :results output drawer :noweb yes
  #lang racket
  (require crypto-trading/test
           crypto-trading/plot)
  (define-values (first-peak fitf)
    (scan-window first-trade second-trade-target test-data-source))
  (define peak-rows (test-data-source first-trade first-peak))
  (println (round (/ (- first-peak first-trade) 60)))
  (println (string-append (number->string (fitf first-trade))
                          " "
                          (number->string(fitf first-peak))))
  (plot-on-frame (list (points peak-rows)
                       (function fitf)))
#+end_src

#+RESULTS: plot-first-peak-no-filters
:results:
4
"72.4375 79.5"
:end:
#+name: test-fit-header
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test
           crypto-trading/plot
           crypto-trading/fit)

#+end_src
Using linear regression to filter out poly regression where linear
makes a better fit.
#+name: plot-first-peak-no-filters-linear-regression
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test
           crypto-trading/fit
           crypto-trading/plot)

  (define-values (first-peak fitf)
    (scan-window first-trade second-trade-target test-data-source))
  (define peak-rows (test-data-source first-trade first-peak))
  (define-values (a b lfitf) (linear-regression (map vector->list peak-rows)))
  (define best-fit (evaluate-models peak-rows fitf lfitf))
  (plot-on-frame (list (points peak-rows)
                       (function fitf)
                       (function lfitf)))
  best-fit
#+end_src

#+RESULTS: plot-first-peak-no-filters-linear-regression
:results:
#<procedure:...-trading/fit.rkt:22:14>
:end:
#+name: test-regression-explicit-squared-error
#+begin_src racket :results output drawer :noweb yes
  #lang racket
  (require crypto-trading/test
           crypto-trading/fit)

  (define rows (test-data-source first-trade (+ 600 first-trade)))
  (define-values (a b lfit) (linear-regression (map vector->list rows)))
  (define pfit (make-fitf rows))
  (define les (squared-error lfit rows))
  (define pes (squared-error pfit rows))
  (list les pes)
#+end_src

#+RESULTS:
:results:
'(0.002749090908243732 66.56590468749998)
:end:
Test find-peak:
Target peak can be detected and situations where linear regression fit better no peak is found
#+name: find-target-peak
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test
           crypto-trading/fit)

  (define first-10-minutes-rows (test-data-source first-trade (+ 600 first-trade)))
  (define 10-min-peak (find-peak first-10-minutes-rows))
  (define first-target-rows (test-data-source first-trade second-trade-target))
  (define trade-peak (find-peak first-target-rows))
  (list 10-min-peak trade-peak)
#+end_src

#+RESULTS: find-peak
:results:
'(#f #<procedure:...-trading/fit.rkt:44:0>)
:end:
Find first peak using find-peak as filter when scanning
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test
           crypto-trading/fit)

  (define first-found-peak (find-first-peak test-data-source first-trade second-trade-target))
  (define delta (- (first-found-peak) first-trade))
  (define hours (exact->inexact (/ delta 3600)))
  (println delta)
  (println hours)

#+end_src

#+RESULTS:
:results:
7200
2.0
:end:

#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/test
           crypto-trading/fit
           crypto-trading/plot)

  (define first-found-peak (find-first-peak test-data-source first-trade second-trade-target))
  (define rows (test-data-source first-trade (first-found-peak)))
  (define analysis (trade-report-analysis first-found-peak))
  (plot-on-frame (list (lines rows)
                       (function (regression-analysis-linearfun analysis))
                       (function (regression-analysis-polyfun analysis))))
  (displayln (regression-analysis-linear-slope analysis))
#+end_src

#+RESULTS:
:results:
0.00011637961346298162
:end:
#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/advicer
           crypto-trading/test)
  ;; First target - advice should be 'buy
  ((get-advice (test-data-source first-trade second-trade-target)))
  ;; First 10 minutes should be 'wait. prize delta too small
  ((get-advice (test-data-source first-trade (+ 600 first-trade))))
  ;; First two hours should be 'wait. prize delta too small
  ((get-advice (test-data-source first-trade (+ 7200 first-trade))))
#+end_src

#+RESULTS:
:results:
'buy
'wait
'wait
:end:

#+begin_src racket :results output drawer
  #lang racket
  (require crypto-trading/advicer
           crypto-trading/test
           crypto-trading/plot)
  (define advice-index (find-first-advice (test-data-source first-trade second-trade-target)))
  (define analysis (trade-report-analysis advice-index))
  (plot-on-frame (list (lines (test-data-source first-trade (advice-index)))))
  (displayln (- advice-index first-trade))
#+end_src

#+RESULTS:
:results:
14400
:end:

** TODO get advice with filters
(get-advice data-source :pre-regression-test ((lambda (data-set)(let ([treshold (* 0.002 (first data-set))])
